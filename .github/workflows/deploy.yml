name: Build and Deploy to AKS

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  IMAGE_NAME: weather-app

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-image-tag.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore WeatherApp/WeatherApp.csproj

      - name: Build application
        run: dotnet build WeatherApp/WeatherApp.csproj --configuration Release --no-restore

      - name: Run tests
        run: dotnet test WeatherApp/WeatherApp.csproj --no-build --verbosity normal || true

      - name: Pull latest base image
        run: docker pull mcr.microsoft.com/dotnet/aspnet:9.0

      - name: Build Docker image locally
        run: docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} -f WeatherApp/Dockerfile WeatherApp

      - name: Install Trivy
        run: |
          sudo apt-get update && sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Scan Docker image with Trivy
        run: trivy image --ignorefile .trivyignore --exit-code 1 --severity HIGH,CRITICAL ${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          auth-type: 'service_principal'

      - name: Build and push Docker image to ACR
        id: set-image-tag
        run: |
          IMAGE_TAG=${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          az acr build \
            --registry ${{ secrets.ACR_NAME }} \
            --image $IMAGE_TAG \
            --file WeatherApp/Dockerfile \
            WeatherApp
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Validate image tag output
        run: |
          echo "Built image tag output: ${{ steps.set-image-tag.outputs.image-tag }}"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          auth-type: 'service_principal'

      - name: Debug image tag in deploy
        run: |
          echo "Image tag: ${{ needs.build.outputs.image-tag }}"

      - name: Setup Azure CLI
        uses: azure/cli@v2
        with:
          inlineScript: echo "Azure CLI setup complete"

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name ${{ secrets.CLUSTER_NAME }} \
            --overwrite-existing

      - name: Test kubectl connection
        run: kubectl cluster-info

      - name: Update deployment image and rollout
        run: |
          kubectl set image deployment/weather-app \
            weather-app=${{ needs.build.outputs.image-tag }}
          kubectl rollout status deployment/weather-app --timeout=600s

      - name: Check deployment status
        run: |
          kubectl get pods -l app=weather-app
          kubectl get service weather-app-service
